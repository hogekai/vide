<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>vide — SSAI Tracking Demo</title>
  <link rel="stylesheet" href="../dist/ui/theme.css">
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
    #player-container { position: relative; width: 100%; background: #000; aspect-ratio: 16/9; }
    #player-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #log { font-family: monospace; font-size: 13px; background: #1a1a1a; color: #0f0; padding: 1rem; max-height: 400px; overflow-y: auto; border-radius: 4px; }
    .log-entry { margin: 2px 0; }
    .log-entry.ad { color: #ff0; }
    .log-entry.track { color: #0ff; }
    .log-entry.quartile { color: #f0f; }
    .controls { margin: 1rem 0; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    button { padding: 0.4rem 1rem; cursor: pointer; }
    .legend { margin: 0.5rem 0; font-size: 13px; font-family: monospace; }
    .legend span { display: inline-block; margin-right: 1rem; }
    .legend .c-green { color: #0f0; }
    .legend .c-yellow { color: #ff0; }
    .legend .c-cyan { color: #0ff; }
    .legend .c-magenta { color: #f0f; }
  </style>
  <script type="importmap">
    { "imports": { "hls.js": "https://esm.sh/hls.js@1" } }
  </script>
</head>
<body>
  <h1>vide — SSAI Tracking Demo</h1>
  <p>
    HLS stream with injected <code>EXT-X-DATERANGE</code> tags.
    Custom parser returns <code>tracking</code> map with URLs for each event.
    All tracking fires are intercepted and shown in the log below.
    Ad breaks: <strong>10s–20s</strong> and <strong>40s–50s</strong>.
  </p>

  <div id="player-container">
    <video id="player"></video>
  </div>

  <div class="controls">
    <button onclick="player.play()">Play</button>
    <button onclick="player.pause()">Pause</button>
    <button onclick="player.currentTime = 0">Restart</button>
    <button onclick="loadStream()">Load Stream</button>
    <button onclick="player.destroy(); log('destroyed')">Destroy</button>
  </div>

  <div class="legend">
    <span class="c-green">system</span>
    <span class="c-yellow">ad event</span>
    <span class="c-cyan">tracking fire</span>
    <span class="c-magenta">quartile</span>
  </div>
  <h3>State: <span id="state">-</span></h3>
  <div id="log"></div>

  <script type="module">
    import { createPlayer } from "../dist/index.mjs";
    import { hls } from "../dist/hls/index.mjs";
    import { ssai } from "../dist/ssai/index.mjs";
    import { ui } from "../dist/ui/index.mjs";

    const el = document.getElementById("player");
    const container = document.getElementById("player-container");
    const stateEl = document.getElementById("state");
    const logEl = document.getElementById("log");

    function log(msg, cls = "") {
      const entry = document.createElement("div");
      entry.className = "log-entry" + (cls ? ` ${cls}` : "");
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logEl.prepend(entry);
      console.log(msg);
    }
    window.log = log;

    // --- Intercept sendBeacon to log tracking fires ---
    const origSendBeacon = navigator.sendBeacon.bind(navigator);
    navigator.sendBeacon = function(url, ...args) {
      if (typeof url === "string" && url.includes("/track/")) {
        // Extract the meaningful part: /track/{adId}/{event}
        const match = url.match(/\/track\/(.+)$/);
        log(`BEACON  ${match ? match[1] : url}`, "track");
      }
      // Don't actually send to example.com — just log it
      return true;
    };

    const player = createPlayer(el);
    window.player = player;

    // --- Register plugins ---
    player.use(hls());
    player.use(ui({ container }));

    // Custom parser: wraps default SCTE35 detection and adds tracking URLs
    player.use(ssai({
      parser(raw) {
        if (raw.source !== "daterange") return [];
        const attrs = raw.attributes;
        if (!attrs["SCTE35-OUT"] && attrs.CLASS !== "com.apple.hls.interstitial") return [];

        const id = attrs.ID;
        if (!id) return [];
        const startDate = attrs["START-DATE"];
        if (!startDate) return [];
        const startTime = (new Date(startDate).getTime() - ANCHOR.getTime()) / 1000;
        const duration = Number(attrs.DURATION || attrs["PLANNED-DURATION"] || 0);

        // Build tracking URLs for every event
        const base = `https://example.com/track/${id}`;
        return [{
          id,
          startTime,
          duration,
          tracking: {
            impression:    [`${base}/impression`],
            start:         [`${base}/start`],
            firstQuartile: [`${base}/firstQuartile`],
            midpoint:      [`${base}/midpoint`],
            thirdQuartile: [`${base}/thirdQuartile`],
            complete:      [`${base}/complete`],
            pause:         [`${base}/pause`],
            resume:        [`${base}/resume`],
            skip:          [`${base}/skip`],
          },
        }];
      },
    }));
    log("HLS + SSAI + UI plugins registered (custom parser with tracking URLs)");

    // --- Wire up events ---
    player.on("statechange", ({ from, to }) => {
      stateEl.textContent = to;
      log(`state: ${from} → ${to}`);
    });
    player.on("play", () => log("event: play"));
    player.on("pause", () => log("event: pause"));
    player.on("ended", () => log("event: ended"));
    player.on("error", ({ code, message }) => log(`error: [${code}] ${message}`));

    // SSAI ad events
    player.on("ad:breakStart", ({ breakId }) => {
      log(`ad:breakStart — ${breakId}`, "ad");
    });
    player.on("ad:start", ({ adId }) => {
      log(`ad:start — ${adId}`, "ad");
    });
    player.on("ad:impression", ({ adId }) => log(`ad:impression — ${adId}`, "ad"));
    player.on("ad:quartile", ({ adId, quartile }) => log(`ad:quartile — ${adId} → ${quartile}`, "quartile"));
    player.on("ad:end", ({ adId }) => {
      log(`ad:end — ${adId}`, "ad");
    });
    player.on("ad:breakEnd", ({ breakId }) => {
      log(`ad:breakEnd — ${breakId}`, "ad");
    });

    log("Player created. State: " + player.state);

    // --- Manifest rewriting ---

    const ORIGIN = "https://test-streams.mux.dev/x36xhzz";
    const MEDIA_PLAYLIST = `${ORIGIN}/url_2/193039199_mp4_h264_aac_ld_7.m3u8`;

    const ANCHOR = new Date("2024-01-01T00:00:00Z");
    window.ANCHOR = ANCHOR; // expose for custom parser

    const AD_BREAKS = [
      { id: "ad-break-1", startSec: 10, durationSec: 10 },
      { id: "ad-break-2", startSec: 40, durationSec: 10 },
    ];

    async function buildSsaiPlaylist() {
      const res = await fetch(MEDIA_PLAYLIST);
      const text = await res.text();
      const lines = text.split("\n");

      const out = [];
      let segIndex = 0;

      const daterangeAt = new Map();
      for (const ab of AD_BREAKS) {
        const idx = Math.floor(ab.startSec / 10);
        const startDate = new Date(ANCHOR.getTime() + ab.startSec * 1000);
        const dr =
          `#EXT-X-DATERANGE:ID="${ab.id}",` +
          `START-DATE="${startDate.toISOString()}",` +
          `DURATION=${ab.durationSec},` +
          `SCTE35-OUT=0x0`;
        daterangeAt.set(idx, (daterangeAt.get(idx) ?? []).concat(dr));
      }

      for (const line of lines) {
        if (line.startsWith("#EXT-X-VERSION:")) {
          out.push("#EXT-X-VERSION:7");
          continue;
        }

        if (line.startsWith("#EXTINF:")) {
          if (segIndex === 0) {
            out.push(`#EXT-X-PROGRAM-DATE-TIME:${ANCHOR.toISOString()}`);
          }
          const drs = daterangeAt.get(segIndex);
          if (drs) {
            for (const dr of drs) out.push(dr);
          }
          out.push(line);
          segIndex++;
          continue;
        }

        if (line && !line.startsWith("#")) {
          out.push(new URL(line, MEDIA_PLAYLIST).href);
          continue;
        }

        out.push(line);
      }

      const playlist = out.join("\n");
      log(`Rewritten playlist (${playlist.length} bytes), ${AD_BREAKS.length} DATERANGE tags injected`);

      const blob = new Blob([playlist], { type: "application/vnd.apple.mpegurl" });
      return URL.createObjectURL(blob) + "#.m3u8";
    }

    window.loadStream = async function() {
      log("Fetching & rewriting playlist with SCTE35-OUT DATERANGE tags…");
      try {
        const blobUrl = await buildSsaiPlaylist();
        log("Loading blob URL into hls.js…");
        player.src = blobUrl;
        player.once("statechange", ({ to }) => {
          if (to === "ready") {
            player.play().catch(() => {
              player.muted = true;
              player.play().catch(() => {});
            });
          }
        });
      } catch (err) {
        log(`Failed to build playlist: ${err.message}`);
      }
    };

    window.loadStream();
  </script>
</body>
</html>
